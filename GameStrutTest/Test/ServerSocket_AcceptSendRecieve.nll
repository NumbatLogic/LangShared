namespace NumbatLogic
{
	class ServerSocket_AcceptSendRecieve
	{
        public static void Run()
		{
			gsServerSocket* pServerSocket = own new gsServerSocket();
			pServerSocket.Start(9876);

			gsClientSocket* pClientSocket = own new gsClientSocket();
			pClientSocket.Connect("localhost", 9876);

			GameStrutTestUtil::Update(pServerSocket, pClientSocket);

			gsClientSocket pServerClientSocket = pServerSocket.Accept();
			Assert::Plz(pServerClientSocket != null);

			{
				gsBlob* pSendBlob = own new gsBlob();
				pSendBlob.PackInt32(619);
				pServerSocket.Send(pSendBlob, 0);
			}

			GameStrutTestUtil::Update(pServerSocket, pClientSocket);

			{
				gsBlob* pReceiveBlob = own pClientSocket.Receive();
				Assert::Plz(pReceiveBlob != null);
				int nRecievedInt;
				Assert::Plz(pReceiveBlob.UnpackInt32(ref nRecievedInt));
				Assert::Plz(nRecievedInt == 619);
			}

			{
				gsBlob* pClientResponseBlob = own new gsBlob();
				pClientResponseBlob.PackInt32(420);
				pClientSocket.Send(pClientResponseBlob);
			}

			GameStrutTestUtil::Update(pServerSocket, pClientSocket);

			{
				gsBlob* pServerReceiveBlob = own pServerClientSocket.Receive();
				Assert::Plz(pServerReceiveBlob != null);
				int nServerReceivedInt;
				Assert::Plz(pServerReceiveBlob.UnpackInt32(ref nServerReceivedInt));
				Assert::Plz(nServerReceivedInt == 420);
			}

			pClientSocket.Disconnect();
			pServerSocket.Stop();
		}
	}
}